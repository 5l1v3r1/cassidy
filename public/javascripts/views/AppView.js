// Generated by CoffeeScript 1.3.3
(function() {
  var AppView;

  AppView = Backbone.View.extend({
    active_panel: 1,
    el: $('#new_secret form'),
    events: {
      'change #master': 'toggle_master',
      'keyup input.required': 'render'
    },
    initialize: function() {
      var $panel, self;
      self = this;
      $panel = $('#swipe .panel');
      window.Swipe = new Swipe($('#swipe')[0], {
        startSlide: self.active_panel,
        callback: function(x, d) {
          return $('#swipe').trigger('swipe.animated');
        }
      });
      App.ConfigView.model.bind('change', this.render, this);
      this.load_master();
      this.focus_input();
      App.is_mobile = /mobile/i.test(navigator.userAgent);
      $('body').on('swipe.animated', '#swipe', function(e) {
        var pos;
        pos = Swipe.getPos();
        if (pos !== self.active_panel) {
          self.active_panel = pos;
          return self.focus_input();
        }
      });
      return $('#secret').on('focus touchstart', function() {
        this.selectionStart = 0;
        this.selectionEnd = this.value.length;
        App.Domains.save({
          url: $('#domain').val(),
          config: App.ConfigView.model.toJSON()
        });
        if (App.is_mobile) {
          return $('small.hint').fadeIn();
        }
      }).on('blur', function() {
        if (App.is_mobile) {
          return $('small.hint').fadeOut();
        }
      });
    },
    load_master: function() {
      return $('#master').val(App.ConfigView.model.get('master'));
    },
    focus_input: function() {
      return $('input.required:visible', this.el).each(function(i) {
        if (!this.value.length) {
          $(this).focus();
          return false;
        }
      });
    },
    toggle_master: function() {
      if (App.ConfigView.model.get('save_all')) {
        return App.ConfigView.saveConfig();
      }
    },
    render: function() {
      var config, secret;
      config = App.ConfigView.model.toJSON();
      secret = new App.Secret({
        master: $('#master').val(),
        domain: $('#domain').val(),
        config: config
      });
      if (secret) {
        $('#secret').val(secret.get('secret'));
        if (App.is_mobile) {
          if ($('#secret').val().length) {
            return $('#secret').show().attr('readonly', false);
          } else {
            return $('#secret').hide().attr('readonly', true);
          }
        }
      }
    }
  });

  App.AppView = new AppView;

}).call(this);
